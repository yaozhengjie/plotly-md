8.8　应用案例：展示产品组合信息

本节以金融行业的一个案例来介绍Plotly在PyQt中的应用。

机构可以从自己的产品信息数据库中筛选出一些优质标的（也就是基金产品），但是对于投资者来说，他们不像机构那么专业，并不能很准确地识别某一种基金产品的好坏，也没有那么多的时间和精力去市场上寻找适合自己投资的基金产品。一边是投资者想要找出适合自己投资的基金产品，另一边是投资者没有能力找出适合自己投资的基金产品，于是就产生了信息堵塞，其表现就是市场上的一些信息无法有效传递到投资者手中。而机构正好掌握了大量这种信息，具有信息优势，于是机构就可以利用这种信息优势给投资者提供服务，并从中收取服务费。

服务的方式很简单，对于投资者来说，他们其实并不知道适合自己的产品是什么类型的，但是可以预期自己的风险和收益。于是就产生了另一个问题：给定投资者的预期收益与风险的范围，为他们提供最优的投资方案。考虑到风险分散的原则，这个最优的投资计划最好是几种产品的组合。

我们先看一下案例结果，如图8-11所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303587217-a46482b6-56d1-4956-b0b8-7fe0a4995aac.jpeg)

图8-11　绘图结果

结果分为两部分，上面的部分是让用户选择预期收益、预期风险及偏好的策略类型，如图8-12所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303587658-64f2abff-846d-408b-82e6-67cb1412e244.jpeg)

图8-12　用户选择部分

下面的部分是从数据库中选取数据，并通过算法找出最优的产品组合及各自的权重，然后用图表展现出来。

提示

出于安全性考虑，这里只提供GUI 的实现逻辑，而不提供基金产品的数据库，也不提供找出最优产品组合的算法。

对于使用Qt Designer进行界面设计这部分内容，这里不再介绍，读者可以参考combination.ui文件自行研究。

本案例涉及的代码逻辑并不复杂，当用户输入预期收益和预期风险范围之后，单击“开始”按钮，就会触发唯一的信号槽机制。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303588184-55bcf63c-9fc7-49dc-834d-fca398c025b0.jpeg)

self.check_check_box()函数用来检测用户选中的策略是否符合要求，其内容如下，意思是在strategy_list中放入已经选中的checkBox的名称。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303588738-4e591779-7eca-4eb2-8d1c-6aa06f41d2a2.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303589327-de9a6bcd-70c4-4e81-89f1-e1fc3e2930bf.jpeg)

下面的内容对于有金融背景的读者来说，理解起来应该没有问题；若没有金融背景，不能理解，则可以略去这部分内容。

当所选择的产品分类数大于3和小于1时都不合适，会弹出警告框，并视为无效。原因是多个产品分类（大于 3）的组合由于产品之间的多重共线性，会导致分类的模型在数学上没有最优解，即使用计算机暴力算法找出最优解，其权重非零的个数一般也不超过3个。所以经过综合考虑，限制产品分类数为1～3是最合适的，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303589734-83b7762b-9e43-429d-88a2-3bd0f889edb5.jpeg)

接下来设置控件的大小和获取参数信息。由于这里并不准备把参数信息导入数据库中，所以只是简单地输出参数信息，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303590788-0755338c-643b-47dc-b5a8-3556f7de5d20.jpeg)

现在假设我们已经从数据库中找出组合最优的3种产品，分别为昆仑三十六号、时时安稳健1号和长城国瑞证券恒通23号，它们的组合权重分别为0.4、0.2和0.4，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303591132-20f04fa6-7ddb-4921-8917-b868d7580fdc.jpeg)

最后就是绘图了，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303591823-d4916467-7fa6-49ae-b9f1-e8a9c7a38592.jpeg)

上面的绘图函数 self.plotly_pyqt5.get_plotly_path_monte_markovitz对应的图相对有些难度，下面简单介绍一下。

通过建立随机的权重进行蒙特卡洛模拟收益率和方差，然后依次计算出 sharp比，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303592397-2373f6e9-3577-40e7-ac24-b5be6a0b8128.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303592941-630e5770-c2cc-4b83-9f42-63a1f1b26077.jpeg)

接下来对收益率和风险进行绘图，不同的 sharp比对应不同的颜色，即颜色是可变的，并添加colorbar，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303593407-02a1d5a3-2ef1-4e5d-b7b8-8fa9eee33f8d.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303593966-808e2908-832f-471b-b189-4d555fab85f5.jpeg)

打开这个程序，然后运行，结果中使用QWebEngineView类所绘制的图表是如此的美丽，这种美丽的动态渲染图在其他GUI程序中很少能够见到，而且它的设计又是那么简单。由此，在内心深处对PyQt有了特别的喜爱。
