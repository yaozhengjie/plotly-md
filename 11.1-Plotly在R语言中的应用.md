11.1　Plotly在R语言中的应用

R语言是用于统计分析、图形表示和报告的编程语言和软件环境。R语言由Ross Ihaka和Robert Gentleman等在新西兰奥克兰大学创建，目前由R语言开发核心团队开发。R语言问世以来，其官方社区为R语言提供了非常多的免费、开源而且强大的模块，这些模块的开发者很多都是学术界的“大牛”，并且紧跟学术前沿，因此R语言在学术界有着非常高的地位。

R语言由于其安装空间小、模块管理方便、易学易用等特点，在数据分析与处理方面有着很重要的地位。使用R语言绘图也非常方便，如大名鼎鼎的ggplot可以说是R语言的绘图神器。但是和python一样，这些绘图模块绘制的图表都是静态的，而Plotly是基于JS的动态绘图模块，本节主要介绍Plotly在R语言中的应用。

### 11.1.1　安装R语言

R语言支持Mac、Linux和Windows三大系统，我们可以从R语言的官方网站（https://cran.r-project.org/）下载对应系统的安装包，这里以 Windows操作系统为例进行介绍。

从R语言官方网站下载R的Windows安装包，并将其保存在本地目录中。它是一个名为“R-version-win.exe”的 Windows安装程序（.exe），只需双击并运行安装程序，接受默认设置即可。如果读者的Windows是32位版本，那么它将安装32位版本；如果读者的Windows是64位版本，那么它将安装32位和64位版本。

安装后，既可以单击桌面上的程序快捷图标运行程序，也可以单击Windows程序文件下的路径“R\R3.2.2\bin\i386\Rgui.exe”运行程序。这时会打开R-GUI，这是一个R控制台，可以在里面进行R语言编程。

### 11.1.2　安装Plotly模块

安装Plotly模块最简单的方法是在控制台中通过以下命令安装：

install.packages("plotly")

安装完成后，在使用这个包里面的函数之前要加载Plotly包，代码如下。

library(plotly)

在这个包里面有一个非常重要的函数plot_ly，它是用来绘制图形的函数。由于R语言的绘图并不是本书的重点，所以本书仅介绍几个入门图形的绘制方法。

### 11.1.3　Plotly应用分析

本节主要介绍 Plotly在 R语言中的基本应用，本节的所有代码都可以在文件code.R中找到。

1.散点图

使用plot_ly函数画几幅简单的图形，最常见的就是散点图。本案例使用模拟的数据进行画图，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303627645-3e266a99-7ca8-4e81-bfe6-d459af614616.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303627999-5d77d118-e36e-44b9-8a9a-e8c5865daabc.jpeg)

绘图结果如图11-1所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303628506-234cbc75-886e-434e-bd83-f52f2b73700a.jpeg)

图11-1　散点图

代码解释如下。

● 第1行代码表示加载Plotly包，加载后可以一直使用Plotly包里面的函数，如果R语言关闭后重新打开，则需要再加载一次该包。

● 第2行代码表示设定随机种子，设定随机种子后，每次产生的随机数将是一样的。

● 第3行代码表示产生样本量为50、均值为0、标准差为1的标准正态分布随机数x1。

● 第4行代码表示产生样本量为50、均值为1、标准差为1的标准正态分布随机数x2。

● 第5行代码表示将产生的两个随机数放入数据框data中（因为plot_ly函数要求data是数据框格式）。

● 第6行代码表示画x1与x2的散点图，其中，x = ～x1表示以x1为X轴（横坐标），y = ～x2表示以x2为Y轴（纵坐标），type ="scatter"表示画图的类型为散点图。

注意

（1）如果读者用的是R 语言，以上代码画的图形会在读者的浏览器网页上显示，如果读者用的是RStudio，则图形会在RStudio 自带的浏览器中显示。

（2）与Python 不同，Plotly 在R 语言中的绘图没有离线绘图与在线绘图之说，所有绘图都是离线绘图。因此，本节内容就没有区分离线绘图与在线绘图。

2.散点图（三维）

使用plot_ly函数绘制三维散点图也是很方便的，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303629052-847ee8a5-7e2d-4402-ba92-a61f5122ebb6.jpeg)

这里的代码与二维散点图中的代码的区别在于type这个参数，只需要把scatter换成scatter3d即可。绘制的结果如图11-2所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303629616-d590d486-ac13-47d6-929a-9e11cf80f4ca.jpeg)

图11-2　三维散点图

3.线形图

接下来介绍一些基本线形图的画法。绘制线形图同样使用plot_ly函数，type参数中没有提供线形的类型，因为在 Plotly里面，线形图是由散点图演变过来的，我们可以在函数里面添加参数mode把散点图的点连接成线，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303630089-2a216b6d-33d3-4417-b55d-eda1b1245298.jpeg)

代码解释如下。

● 第2行seq函数表示生成有规律的序列，我们在此生成从1到50、间隔为1的50个数据。

● 第3行代码表示产生样本量为50、均值为0、标准差为1的标准正态分布随机数y。

● 第4行代码表示将数据x、y放入数据框data中。

● 第5行代码表示以x为横轴、以y为纵轴画线形图。

绘制结果如图11-3所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303630595-0f24375e-f135-4c13-bd79-dbb01bfe0f49.jpeg)

图11-3　线形图

在图11-3中我们只画了一条线，也可以在同一幅图中画多条线，有两种方法可以完成这个工作。接下来用两种方法在同一幅图中画出三条线。

第一种方法：先画出一条线，然后在该图形中添加另外两条线。

第二种方法：先画出坐标轴（画出横轴），然后在坐标轴中添加三条线。

4.线形图（多元1）

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303631024-bc052e64-d861-4b10-b40a-f12148c9e3c0.jpeg)

代码解释如下。

● 第1行代码表示设定随机种子。

● 第2、3、4行代码表示生成随机数，我们在此设定均值分别为0、3、6，主要是为了便于观察图形。

● 第5行代码表示产生1到50、间隔为1的序列。

● 第6行代码表示将x、y1、y2、y3放到数据框data中。

● 第7行代码表示以x为横坐标轴、以y1为纵坐标轴画线形图。

● 第8行代码表示在原坐标轴上添加曲线y2。

● 第9行代码表示在原坐标轴上添加曲线y3。

注意

第7、8、9行中的name参数表示将曲线y1命名为y1、将曲线y2命名为y2、将曲线y3命名为y3。

参数mode表示线条类型，lines表示加线，markers表示为对应的点加上标记，它们可以同时使用，即lines+markers。

%>%可以表示一个连接符，连接符后面还有语句，直到语句后面不再出现%>%时，执行从开始出现%>%到结束的语句。

绘图结果如图11-4所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303631350-d8c0629c-f3e5-4802-bd7a-de86b18271c5.jpeg)

图11-4　三条曲线图

5.线形图（多元2）

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303631718-7d317591-b189-41d0-8684-c258064b3bfb.jpeg)

绘图结果如图11-5所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303632078-e8c77310-172a-446b-866c-df41ee5e564f.jpeg)

图11-5　三条曲线图

从图11-4和图11-5可以看出，上面两种方法绘图的结果是一样的，只是实现的方法不一样。

### 11.1.4　更多扩展

使用 plot_ly函数可以画多种类型的图，比较简单的方法是通过修改参数 type来实现，type的可选参数有："scatter"、"box"、"bar"、"heatmap"、"histogram"、"histogram2d"、"histogram2dcontour"、"pie"、"contour"、"scatterternary"、"sankey"、"scatter3d"、"surface"、"mesh3d"、"scattergeo"、"choropleth"、"scattergl"、"pointcloud"、"heatmapgl"、"parcoords"、"scattermapbox"、"carpet"、"scattercarpet"、"contourcarpet"、"ohlc"、"candlestick"和"area"。具体的使用方法及案例可参考 Plotly中的 plot_ly函数的使用方法。

如果读者对 Plotly在 R语言中的应用有更多的需求，可以参考官方网站https://plot.ly/r/，在这个网站中可以找到绝大部分想要的案例，官网部分截图如图11-6所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303632357-79311d63-7c53-4d7f-9f70-add0d53d766f.jpeg)

图11-6　官网部分截图
